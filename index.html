<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        .gauge {
            width: 100%;
            max-width: 250px;
            font-family: 'Roboto', sans-serif;
            font-size: 32px;
            color: #004033;
        }
        
        .gauge__body {
            width: 100%;
            height: 0;
            padding-bottom: 50%;
            position: relative;
            border-top-left-radius: 100% 200%;
            border-top-right-radius: 100% 200%;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        .gauge__fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: inherit;
            height: 100%;
            background-color: #10b981;
            transform-origin: center top;
            transform: rotate(0.5turn);
            transition: transform 0.5s ease-out;
        }
        
        .gauge__cover {
            width: 75%;
            height: 150%;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 25%;
            box-sizing: border-box;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-tint text-primary text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">Smart Irrigation System</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="connection-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                        <span class="w-2 h-2 mr-2 rounded-full bg-red-500"></span>
                        Disconnected
                    </span>
                    <button id="connect-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition">
                        Connect to ESP32
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-50 text-blue-600">
                            <i class="fas fa-water text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Current Moisture</p>
                            <p id="current-moisture" class="text-2xl font-semibold text-gray-900">--%</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-50 text-green-600">
                            <i class="fas fa-leaf text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Threshold</p>
                            <p id="moisture-threshold" class="text-2xl font-semibold text-gray-900">30%</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-50 text-purple-600">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Last Watering</p>
                            <p id="last-watering" class="text-2xl font-semibold text-gray-900">--:--</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-50 text-yellow-600">
                            <i class="fas fa-power-off text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Pump Status</p>
                            <p id="pump-status" class="text-2xl font-semibold text-gray-900">OFF</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Moisture Gauge -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-1">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Soil Moisture Level</h2>
                    <div class="flex justify-center">
                        <div class="gauge">
                            <div class="gauge__body">
                                <div id="gauge-fill" class="gauge__fill"></div>
                                <div class="gauge__cover">
                                    <span id="gauge-value">--%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="moisture-range" class="block text-sm font-medium text-gray-700">Moisture Threshold</label>
                        <input type="range" id="moisture-range" min="0" max="100" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span id="threshold-value">30%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <button id="update-threshold" class="mt-4 w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                        Update Threshold
                    </button>
                </div>

                <!-- Controls -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-1">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Manual Controls</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pump Control</label>
                            <div class="flex space-x-2">
                                <button id="pump-on" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">
                                    <i class="fas fa-play mr-2"></i> Turn On
                                </button>
                                <button id="pump-off" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">
                                    <i class="fas fa-stop mr-2"></i> Turn Off
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Watering Duration</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="watering-duration" min="1" max="60" value="5" class="flex-1 border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                <span class="text-sm text-gray-500">seconds</span>
                            </div>
                        </div>
                        
                        <button id="water-now" class="w-full bg-secondary text-white py-2 px-4 rounded-md hover:bg-green-600 transition flex items-center justify-center">
                            <i class="fas fa-tint mr-2"></i> Water Now
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">System Settings</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="auto-mode" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                                <label for="auto-mode" class="ml-2 block text-sm text-gray-700">Automatic Mode</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="notifications" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                                <label for="notifications" class="ml-2 block text-sm text-gray-700">Enable Notifications</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Moisture Chart -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-1">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900">Moisture History</h2>
                        <select id="time-range" class="border border-gray-300 rounded-md py-1 px-2 text-sm focus:outline-none focus:ring-primary focus:border-primary">
                            <option value="1">Last Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="moisture-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Logs -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">Irrigation Logs</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-logs" class="text-primary hover:text-blue-600 transition">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="clear-logs" class="text-red-500 hover:text-red-600 transition">
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moisture</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logs-body" class="bg-white divide-y divide-gray-200">
                            <!-- Logs will be inserted here by JavaScript -->
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No data available. Connect to your ESP32 device.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Connection Modal -->
    <div id="connection-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-wifi text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Connect to ESP32</h3>
                            <div class="mt-2">
                                <div class="space-y-4">
                                    <div>
                                        <label for="wifi-ssid" class="block text-sm font-medium text-gray-700">WiFi SSID</label>
                                        <input type="text" id="wifi-ssid" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                    </div>
                                    <div>
                                        <label for="wifi-password" class="block text-sm font-medium text-gray-700">WiFi Password</label>
                                        <input type="password" id="wifi-password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                    </div>
                                    <div>
                                        <label for="device-ip" class="block text-sm font-medium text-gray-700">Device IP (optional)</label>
                                        <input type="text" id="device-ip" placeholder="192.168.x.x" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="connect-confirm" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Connect
                    </button>
                    <button id="connect-cancel" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden max-w-sm w-full">
            <div class="flex items-center px-4 py-3">
                <div id="toast-icon" class="text-green-500">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="ml-3">
                    <p id="toast-title" class="text-sm font-medium text-gray-900">Success</p>
                    <p id="toast-message" class="text-sm text-gray-500">Operation completed successfully.</p>
                </div>
                <button id="toast-close" class="ml-auto text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Mock data for demonstration
        let mockData = {
            currentMoisture: 45,
            threshold: 30,
            pumpStatus: false,
            lastWatering: null,
            logs: [
                { id: 1, timestamp: '2023-06-15 10:30:45', moisture: 28, action: 'AUTO', duration: 8, status: 'COMPLETED' },
                { id: 2, timestamp: '2023-06-15 08:15:22', moisture: 32, action: 'AUTO', duration: 5, status: 'COMPLETED' },
                { id: 3, timestamp: '2023-06-14 22:45:10', moisture: 25, action: 'MANUAL', duration: 10, status: 'COMPLETED' },
                { id: 4, timestamp: '2023-06-14 18:30:05', moisture: 40, action: 'AUTO', duration: 0, status: 'SKIPPED' },
                { id: 5, timestamp: '2023-06-14 14:20:33', moisture: 27, action: 'AUTO', duration: 7, status: 'COMPLETED' }
            ],
            history: generateMoistureHistory()
        };

        // Generate mock moisture history data
        function generateMoistureHistory() {
            const history = [];
            const now = new Date();
            
            for (let i = 23; i >= 0; i--) {
                const time = new Date(now);
                time.setHours(now.getHours() - i);
                
                // Simulate natural moisture changes with some randomness
                let moisture;
                if (i > 18) {
                    moisture = 45 + Math.random() * 5; // Night time - higher moisture
                } else if (i > 12) {
                    moisture = 30 + Math.random() * 10; // Afternoon - lower moisture
                } else if (i > 6) {
                    moisture = 35 + Math.random() * 10; // Morning - medium moisture
                } else {
                    moisture = 40 + Math.random() * 10; // Evening - higher moisture
                }
                
                // Add watering effects
                if (i === 10 || i === 18) {
                    moisture = 80 + Math.random() * 10;
                }
                
                // Ensure moisture is between 0-100
                moisture = Math.max(0, Math.min(100, Math.round(moisture)));
                
                history.push({
                    time: time,
                    moisture: moisture
                });
            }
            
            return history;
        }

        // DOM Elements
        const connectionModal = document.getElementById('connection-modal');
        const connectBtn = document.getElementById('connect-btn');
        const connectConfirm = document.getElementById('connect-confirm');
        const connectCancel = document.getElementById('connect-cancel');
        const connectionStatus = document.getElementById('connection-status');
        const currentMoisture = document.getElementById('current-moisture');
        const moistureThreshold = document.getElementById('moisture-threshold');
        const lastWatering = document.getElementById('last-watering');
        const pumpStatus = document.getElementById('pump-status');
        const gaugeFill = document.getElementById('gauge-fill');
        const gaugeValue = document.getElementById('gauge-value');
        const moistureRange = document.getElementById('moisture-range');
        const thresholdValue = document.getElementById('threshold-value');
        const updateThreshold = document.getElementById('update-threshold');
        const pumpOn = document.getElementById('pump-on');
        const pumpOff = document.getElementById('pump-off');
        const waterNow = document.getElementById('water-now');
        const wateringDuration = document.getElementById('watering-duration');
        const autoMode = document.getElementById('auto-mode');
        const notifications = document.getElementById('notifications');
        const timeRange = document.getElementById('time-range');
        const refreshLogs = document.getElementById('refresh-logs');
        const clearLogs = document.getElementById('clear-logs');
        const logsBody = document.getElementById('logs-body');
        const toast = document.getElementById('toast');
        const toastClose = document.getElementById('toast-close');

        // Chart
        let moistureChart;
        const ctx = document.getElementById('moisture-chart').getContext('2d');

        // Initialize the dashboard
        function initDashboard() {
            updateUI();
            renderLogs();
            initChart();
            
            // Set up event listeners
            setupEventListeners();
            
            // Simulate real-time updates
            setInterval(simulateRealTimeUpdates, 5000);
        }

        // Update UI with current data
        function updateUI() {
            // Current moisture
            currentMoisture.textContent = mockData.currentMoisture + '%';
            gaugeValue.textContent = mockData.currentMoisture + '%';
            
            // Update gauge
            const rotation = mockData.currentMoisture / 100 * 0.5;
            gaugeFill.style.transform = `rotate(${rotation}turn)`;
            
            // Update gauge color based on moisture level
            if (mockData.currentMoisture < mockData.threshold) {
                gaugeFill.style.backgroundColor = '#ef4444'; // red
            } else if (mockData.currentMoisture < mockData.threshold + 10) {
                gaugeFill.style.backgroundColor = '#f59e0b'; // yellow
            } else {
                gaugeFill.style.backgroundColor = '#10b981'; // green
            }
            
            // Threshold
            moistureThreshold.textContent = mockData.threshold + '%';
            moistureRange.value = mockData.threshold;
            thresholdValue.textContent = mockData.threshold + '%';
            
            // Pump status
            pumpStatus.textContent = mockData.pumpStatus ? 'ON' : 'OFF';
            pumpStatus.className = `text-2xl font-semibold ${mockData.pumpStatus ? 'text-green-600' : 'text-gray-900'}`;
            
            // Last watering
            if (mockData.lastWatering) {
                const date = new Date(mockData.lastWatering);
                lastWatering.textContent = date.toLocaleTimeString();
            } else {
                lastWatering.textContent = 'Never';
            }
        }

        // Render logs table
        function renderLogs() {
            if (mockData.logs.length === 0) {
                logsBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No data available.</td></tr>';
                return;
            }
            
            let html = '';
            mockData.logs.forEach(log => {
                let statusClass = '';
                if (log.status === 'COMPLETED') {
                    statusClass = 'bg-green-100 text-green-800';
                } else if (log.status === 'SKIPPED') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                } else if (log.status === 'FAILED') {
                    statusClass = 'bg-red-100 text-red-800';
                }
                
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.moisture}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.duration}s</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${log.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-primary hover:text-blue-600 mr-3" onclick="editLog(${log.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-600" onclick="deleteLog(${log.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            logsBody.innerHTML = html;
        }

        // Initialize chart
        function initChart() {
            const labels = mockData.history.map(item => {
                const date = new Date(item.time);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            });
            
            const data = mockData.history.map(item => item.moisture);
            
            moistureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Soil Moisture (%)',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update chart based on time range
        function updateChart(rangeHours) {
            // In a real app, you would fetch data for the selected time range
            // Here we'll just filter our mock data
            const now = new Date();
            const cutoff = new Date(now.getTime() - rangeHours * 60 * 60 * 1000);
            
            const filteredHistory = mockData.history.filter(item => new Date(item.time) >= cutoff);
            
            const labels = filteredHistory.map(item => {
                const date = new Date(item.time);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            });
            
            const data = filteredHistory.map(item => item.moisture);
            
            moistureChart.data.labels = labels;
            moistureChart.data.datasets[0].data = data;
            moistureChart.update();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Connection modal
            connectBtn.addEventListener('click', () => {
                connectionModal.classList.remove('hidden');
            });
            
            connectConfirm.addEventListener('click', () => {
                const ssid = document.getElementById('wifi-ssid').value;
                const password = document.getElementById('wifi-password').value;
                const ip = document.getElementById('device-ip').value;
                
                if (ssid) {
                    // In a real app, you would connect to the ESP32 here
                    // For this demo, we'll just simulate a successful connection
                    connectionModal.classList.add('hidden');
                    connectionStatus.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                    connectionStatus.innerHTML = '<span class="w-2 h-2 mr-2 rounded-full bg-green-500"></span> Connected';
                    connectBtn.textContent = 'Disconnect';
                    
                    showToast('Connected', 'Successfully connected to your ESP32 device.', 'success');
                } else {
                    showToast('Error', 'Please enter WiFi credentials.', 'error');
                }
            });
            
            connectCancel.addEventListener('click', () => {
                connectionModal.classList.add('hidden');
            });
            
            // Threshold controls
            moistureRange.addEventListener('input', () => {
                thresholdValue.textContent = moistureRange.value + '%';
            });
            
            updateThreshold.addEventListener('click', () => {
                const newThreshold = parseInt(moistureRange.value);
                mockData.threshold = newThreshold;
                updateUI();
                showToast('Threshold Updated', `Moisture threshold set to ${newThreshold}%`, 'success');
            });
            
            // Pump controls
            pumpOn.addEventListener('click', () => {
                mockData.pumpStatus = true;
                updateUI();
                showToast('Pump Activated', 'Water pump turned on manually.', 'success');
                
                // Simulate pump turning off after 5 seconds
                setTimeout(() => {
                    mockData.pumpStatus = false;
                    updateUI();
                }, 5000);
            });
            
            pumpOff.addEventListener('click', () => {
                mockData.pumpStatus = false;
                updateUI();
                showToast('Pump Deactivated', 'Water pump turned off manually.', 'success');
            });
            
            waterNow.addEventListener('click', () => {
                const duration = parseInt(wateringDuration.value) || 5;
                mockData.pumpStatus = true;
                mockData.lastWatering = new Date().toISOString();
                
                // Add to logs
                const newLog = {
                    id: mockData.logs.length + 1,
                    timestamp: new Date().toLocaleString(),
                    moisture: mockData.currentMoisture,
                    action: 'MANUAL',
                    duration: duration,
                    status: 'COMPLETED'
                };
                mockData.logs.unshift(newLog);
                
                updateUI();
                renderLogs();
                showToast('Watering Started', `Watering for ${duration} seconds.`, 'success');
                
                // Simulate pump turning off after duration
                setTimeout(() => {
                    mockData.pumpStatus = false;
                    updateUI();
                }, duration * 1000);
            });
            
            // Time range selector
            timeRange.addEventListener('change', () => {
                const range = parseInt(timeRange.value);
                updateChart(range);
            });
            
            // Log controls
            refreshLogs.addEventListener('click', () => {
                // In a real app, you would fetch fresh logs from the server
                renderLogs();
                showToast('Logs Refreshed', 'Irrigation logs updated.', 'info');
            });
            
            clearLogs.addEventListener('click', () => {
                // In a real app, you would confirm this action
                mockData.logs = [];
                renderLogs();
                showToast('Logs Cleared', 'All irrigation logs have been removed.', 'warning');
            });
            
            // Toast close
            toastClose.addEventListener('click', () => {
                toast.classList.add('hidden');
            });
        }

        // Show notification toast
        function showToast(title, message, type) {
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            // Set icon and color based on type
            let iconClass, iconColor;
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle';
                    iconColor = 'text-red-500';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    iconColor = 'text-yellow-500';
                    break;
                case 'info':
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-blue-500';
                    break;
                default:
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-gray-500';
            }
            
            toastIcon.className = iconClass + ' ' + iconColor;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toast.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // Simulate real-time updates from ESP32
        function simulateRealTimeUpdates() {
            if (!connectionStatus.textContent.includes('Connected')) return;
            
            // Randomly change moisture level
            let change = (Math.random() - 0.5) * 5; // -2.5 to +2.5
            mockData.currentMoisture = Math.max(0, Math.min(100, Math.round(mockData.currentMoisture + change)));
            
            // Check if we need to water (in auto mode)
            if (autoMode.checked && !mockData.pumpStatus && mockData.currentMoisture < mockData.threshold) {
                mockData.pumpStatus = true;
                mockData.lastWatering = new Date().toISOString();
                
                // Add to logs
                const newLog = {
                    id: mockData.logs.length + 1,
                    timestamp: new Date().toLocaleString(),
                    moisture: mockData.currentMoisture,
                    action: 'AUTO',
                    duration: 5,
                    status: 'COMPLETED'
                };
                mockData.logs.unshift(newLog);
                
                showToast('Auto Watering', 'Soil is dry. Starting automatic watering.', 'info');
                
                // Simulate pump turning off after 5 seconds
                setTimeout(() => {
                    mockData.pumpStatus = false;
                    // Simulate moisture increase after watering
                    mockData.currentMoisture = Math.min(100, mockData.currentMoisture + 15 + Math.random() * 10);
                    updateUI();
                }, 5000);
            }
            
            // Add to history
            const now = new Date();
            mockData.history.push({
                time: now,
                moisture: mockData.currentMoisture
            });
            
            // Keep only last 24 hours of data
            const cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            mockData.history = mockData.history.filter(item => new Date(item.time) >= cutoff);
            
            updateUI();
            renderLogs();
            
            // Update chart if showing last 24 hours
            if (parseInt(timeRange.value) === 24) {
                updateChart(24);
            }
        }

        // CRUD functions for logs (would be API calls in a real app)
        function editLog(id) {
            const log = mockData.logs.find(log => log.id === id);
            if (log) {
                showToast('Edit Log', `Editing log #${id} (${log.action} watering)`, 'info');
                // In a real app, you would open an edit modal/form
            }
        }
        
        function deleteLog(id) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                mockData.logs = mockData.logs.filter(log => log.id !== id);
                renderLogs();
                showToast('Log Deleted', 'The log entry has been removed.', 'success');
            }
        }

        // Expose functions to global scope for inline event handlers
        window.editLog = editLog;
        window.deleteLog = deleteLog;

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
